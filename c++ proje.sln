#include <iostream>
#include <fstream>
#include <string>
#include <vector>

using namespace std;

struct Book {
    string title;
    string author;
    string isbn;
    string genre;
};

struct User {
    string username;
    string password;
};

void addUserToFile(const User& user) {
    ofstream outputFile("users.txt", ios::app);
    outputFile << user.username << "," << user.password << endl;
    outputFile.close();
    cout << "The user has been registered: " << "'" << user.username << "'" << endl;
}

bool checkUserCredentials(const string& username, const string& password) {
    ifstream inputFile("users.txt");
    string line;
    while (getline(inputFile, line)) {
        size_t pos = line.find(",");
        string savedUsername = line.substr(0, pos);
        string savedPassword = line.substr(pos + 1);
        if (username == savedUsername && password == savedPassword) {
            inputFile.close();
            return true;
        }
    }
    inputFile.close();
    return false;
}

vector<Book> readBooksFromFile() {
    vector<Book> books;
    ifstream inputFile("books.txt");
    string line;
    while (getline(inputFile, line)) {
        Book book;
        size_t pos1 = line.find(",");
        book.title = line.substr(0, pos1);
        size_t pos2 = line.find(",", pos1 + 1);
        book.author = line.substr(pos1 + 1, pos2 - pos1 - 1);
        size_t pos3 = line.find(",", pos2 + 1);
        book.isbn = line.substr(pos2 + 1, pos3 - pos2 - 1);
        book.genre = line.substr(pos3 + 1);
        books.push_back(book);
    }
    inputFile.close();

    return books;
}

void writeBooksToFile(const vector<Book>& books) {
    ofstream outputFile("books.txt", ios::trunc);
    for (const Book& book : books) {
        outputFile << book.title << "," << book.author << "," << book.isbn << "," << book.genre << endl;
    }
    outputFile.close();
}

void addBook(vector<Book>& books) {
    Book newBook;

    cout << "Book Name: ";
    getline(cin, newBook.title);

    cout << "Author's Name:";
    getline(cin, newBook.author);

    cout << "ISBN: ";
    getline(cin, newBook.isbn);

    cout << "Book Genre: ";
    getline(cin, newBook.genre);

    books.push_back(newBook);
    writeBooksToFile(books);

    cout << "The book was added successfully." << "'" << newBook.title << "'" << endl;
}

void listBooks(const vector<Book>& books) {
    for (const Book& book : books) {
        cout << book.title << " - " << book.author << " - " << book.isbn << " - " << book.genre << endl;
    }
}

int findBookIndex(const vector<Book>& books, const string& title) {
    for (int i = 0; i < books.size(); i++) {
        if (books[i].title == title) {
            return i;
        }
    }
    return -1;
}

void borrowBook(vector<Book>& books) {
    string title;
    cout << "Enter the name o f the book you want buy: ";
    getline(cin, title);

    int index = findBookIndex(books, title);
    if (index == -1) {
        cout << "The book could not be found." << "'" << title << "'" << endl;
    }
    else {
        cout << "The book was purchased." << "'" << title << "'" << endl;
        books.erase(books.begin() + index);
        writeBooksToFile(books);
    }
}

void updateBook(vector<Book>& books) {
    string title;
    cout << "Enter the name of the book you want to update: ";
    getline(cin, title);
    int index = findBookIndex(books, title);
    if (index == -1) {
        cout << "The book could not be found." << title << endl;
    }
    else {
        cout << "Enter the book information: " << endl;
        Book updatedBook;

        cout << "The name of the new book: ";
        getline(cin, updatedBook.title);

        cout << "The author's name of the new book: ";
        getline(cin, updatedBook.author);

        cout << "The ISBN of the new book: ";
        getline(cin, updatedBook.isbn);

        books[index] = updatedBook;
        writeBooksToFile(books);

        cout << "The book has been successfully updated." << updatedBook.title << endl;
    }
}

void deleteBook(vector<Book>& books) {
    string title;
    cout << "Enter the name of the bookyou want to delete: ";
    getline(cin, title);
    int index = findBookIndex(books, title);
    if (index == -1) {
        cout << "The book could not be found." << title << endl;
    }
    else {
        cout << "The book was deleted." << title << endl;
        books.erase(books.begin() + index);
        writeBooksToFile(books);
    }
}

int main() {
    vector<Book> books = readBooksFromFile();
    User user;
    cout << "Username: ";
    getline(cin, user.username);

    cout << "Password: ";
    getline(cin, user.password);

    addUserToFile(user);

    if (!checkUserCredentials(user.username, user.password)) {
        cout << "Incorrect username or password." << endl;
        cout << "Try again!" << endl;
        return 1;
    }

    int choice;
    do {
        cout << "-------------------" << endl;
        cout << "HOW CAN I HELP YOU?" << endl;
        cout << "-------------------" << endl;
        cout << "1. Add Book" << endl;
        cout << "2. Display Books" << endl;
        cout << "3. Buy Book" << endl;
        cout << "4. Update Book" << endl;
        cout << "5. Delete Book" << endl;
        cout << "0. Exit" << endl;
        cout << "-------------------" << endl;
        cout << "==> ";

        cin >> choice;
        cin.ignore();

        switch (choice) {
        case 1:
            addBook(books);
            break;
        case 2:
            listBooks(books);
            break;
        case 3:
            borrowBook(books);
            break;
        case 4:
            updateBook(books);
            break;
        case 5:
            deleteBook(books);
            break;
        case 0:
            cout << "The program has been terminated." << endl;
            break;
        default:
            cout << "Invalid election!" << endl;
            break;
        }
    } while (choice != 0);

    return 0;
}
